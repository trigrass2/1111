/*
 * @Author: zhongwei
 * @Date: 2020/4/1 16:11:18
 * @Description: Goose接收处理接口代码
 * @File: bm_goose_rcv.cc
 *
*/

#include "plt_include.h"
#include "bm_goose_rcv.h"


#define SEND_MAX_NUM  2048
#define GOOSE_MAX_NUM  3


uint8 goosesendbuftemp[GOOSE_MAX_NUM][SEND_MAX_NUM];
uint8 goosesendbuf[GOOSE_MAX_NUM][SEND_MAX_NUM];
uint8 gooserecvbuf[GOOSE_MAX_NUM][SEND_MAX_NUM];

int goosesend(int phy_no,uint8 *buf,uint32 len)
{
	int num, i;
	uint32 port;

	if(phy_no >= GOOSE_MAX_NUM)
		return ERROR;
	port = 1 << (phy_no + 2);
	
	memset(goosesendbuftemp[phy_no], 0, SEND_MAX_NUM);
	memset(goosesendbuf[phy_no], 0, SEND_MAX_NUM);
	memcpy(goosesendbuftemp[phy_no], buf, len);

	num = (len)/4*4;
	for(i = 0; i <= num; i += 4)
	{
		goosesendbuf[phy_no][8+i+3] = goosesendbuftemp[phy_no][0+i];
		goosesendbuf[phy_no][8+i+2] = goosesendbuftemp[phy_no][1+i];
		goosesendbuf[phy_no][8+i+1] = goosesendbuftemp[phy_no][2+i];
		goosesendbuf[phy_no][8+i+0] = goosesendbuftemp[phy_no][3+i];
	}	

	if(axi_hp_fill_goose_msg_head(goosesendbuf[phy_no],port,len) == -1)
		return ERROR;
	
	if(axi_hp_send_msg(goosesendbuf[phy_no], len+8) == 0)
		return OK;
	else
		return ERROR;

	
}

//设置接收过滤
int goose_set_rcv(DWORD phy_no,const BYTE * dest_mac, 
                                                  WORD app_id, 
                                                  const char * gocbRef,
                                                  const char * datSet,
                                                  const char * goID)
{
  	uint32 port;

	if(phy_no >= GOOSE_MAX_NUM)
		return ERROR;
	port = 1 << (phy_no + 2);

    if(fpga_add_one_goose_rcv(dest_mac, app_id, gocbRef, datSet, goID, port) == XST_SUCCESS)
		return OK;
	else
		return ERROR;
}

/**
 * @Function: on_bm_goose_rcv
 * @Description: 接收到Goose报文进一步处理接口 
 * @author zhongwei (2020/4/1 16:15:02)
 * 
 * @return SECTION_PLT_CODE void 
 * 
*/
SECTION_PLT_CODE void on_bm_goose_rcv(const TFRAME_GOOSE_RCV * pGoose)
{
	//因FPGA是大端，故需要转换小端处理。
	int i,len;
	uint16 phy_no;
	
	len = pGoose->data_len;
	phy_no = pGoose->port;

	for(i = 0; i < 16; i++)
	{
		if(pGoose->port == (1<<i))
			break;
	}

	if(i == 16)
		return;

	if(i < 2)
		return;
	
	phy_no = i - 2;

	//大端转小端
	len = ((len + 3) >> 2) << 2;
	
	for(i = 0 ; i < len; i += 4)
	{
		gooserecvbuf[phy_no][i+3] = pGoose->data[0+i];
		gooserecvbuf[phy_no][i+2] = pGoose->data[1+i];
		gooserecvbuf[phy_no][i+1] = pGoose->data[2+i];
		gooserecvbuf[phy_no][i+0] = pGoose->data[3+i];
	}
	
	//接收处理     端口phy_no     gooserecvbuf[phy_no]  长度pGoose->data_len
	
	
}




/*
0000   01 0c cd 01 00 09 01 0c cd 01 00 01 88 b8 00 00
0010   00 80 00 00 00 00 61 76 80 1d 49 50 41 43 53 5f
0020   30 31 50 49 47 4f 2f 4c 4c 4e 30 24 47 4f 24 64
0030   73 47 4f 4f 53 45 31 81 03 01 00 00 82 08 64 73
0040   47 4f 4f 53 45 31 83 1d 49 50 41 43 53 5f 30 31
0050   50 49 47 4f 2f 4c 4c 4e 30 24 47 4f 24 64 73 47
0060   4f 4f 53 45 31 84 08 00 00 00 00 00 00 00 00 85
0070   02 5c c8 86 02 06 d4 87 01 00 88 01 00 89 01 00
0080   8a 01 01 ab 09 83 01 00 83 01 00 83 01 00

Destination: Iec-Tc57_01:00:09 (01:0c:cd:01:00:09)
dest_mac  01 0c cd 01 00 09
appid     0x0000
gocbRef: IPACS_01PIGO/LLN0$GO$dsGOOSE1
datSet: dsGOOSE1
goID: IPACS_01PIGO/LLN0$GO$dsGOOSE1
*/

uint8 goose_send[] = 
{
  0x01, 0x0c, 0xcd, 0x01, 0x00, 0x09, 0x01, 0x0c, 0xcd, 0x01, 0x00, 0x01,  0x81, 0x00, 0x80, 0x07 ,0x88, 0xb8, 0x00, 0x00,
  0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x61, 0x76, 0x80, 0x1d, 0x49, 0x50, 0x41, 0x43, 0x53, 0x5f, 
  0x30, 0x31, 0x50, 0x49, 0x47, 0x4f, 0x2f, 0x4c, 0x4c, 0x4e, 0x30, 0x24, 0x47, 0x4f, 0x24, 0x64, 
  0x73, 0x47, 0x4f, 0x4f, 0x53, 0x45, 0x31, 0x81, 0x03, 0x01, 0x00, 0x00, 0x82, 0x08, 0x64, 0x73, 
  0x47, 0x4f, 0x4f, 0x53, 0x45, 0x31, 0x83, 0x1d, 0x49, 0x50, 0x41, 0x43, 0x53, 0x5f, 0x30, 0x31, 
  0x50, 0x49, 0x47, 0x4f, 0x2f, 0x4c, 0x4c, 0x4e, 0x30, 0x24, 0x47, 0x4f, 0x24, 0x64, 0x73, 0x47, 
  0x4f, 0x4f, 0x53, 0x45, 0x31, 0x84, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x85, 
  0x02, 0x5c, 0xc8, 0x86, 0x02, 0x06, 0xd4, 0x87, 0x01, 0x00, 0x88, 0x01, 0x00, 0x89, 0x01, 0x00, 
  0x8a, 0x01, 0x03, 0xab, 0x09, 0x83, 0x01, 0x00, 0x83, 0x01, 0x00, 0x83, 0x01, 0x00,
};

uint8 goose_send1[] = 
{  
  0x01, 0x0c, 0xcd, 0x01, 0x00, 0x01, 0xe8, 0x6a, 0x64, 0x82, 0x7b, 0x81, 0x81, 0x00, 0x80, 0x07
, 0x88, 0xb8, 0x20, 0x00, 0x00, 0xaf, 0x00, 0x00, 0x00, 0x00, 0x61, 0x81, 0xa4, 0x80, 0x08, 0x67
, 0x6f, 0x63, 0x62, 0x52, 0x65, 0x66, 0x30, 0x81, 0x05, 0x00, 0x00, 0x00, 0x27, 0x10, 0x82, 0x08
, 0x64, 0x61, 0x74, 0x61, 0x53, 0x65, 0x74, 0x30, 0x83, 0x05, 0x67, 0x6f, 0x49, 0x64, 0x30, 0x84
, 0x08, 0x5f, 0x02, 0x93, 0xd9, 0xc2, 0x0c, 0x4a, 0x00, 0x85, 0x05, 0x00, 0x00, 0x00, 0x00, 0x01
, 0x86, 0x05, 0x00, 0x00, 0x00, 0x00, 0x01, 0x87, 0x01, 0x01, 0x88, 0x05, 0x00, 0x00, 0x00, 0x00
, 0x01, 0x89, 0x01, 0x00, 0x8a, 0x05, 0x00, 0x00, 0x00, 0x00, 0x1c, 0xab, 0x54, 0x83, 0x01, 0x01
, 0x83, 0x01, 0x01, 0x83, 0x01, 0x01, 0x83, 0x01, 0x01, 0x83, 0x01, 0x01, 0x83, 0x01, 0x01, 0x83
, 0x01, 0x01, 0x83, 0x01, 0x01, 0x83, 0x01, 0x01, 0x83, 0x01, 0x01, 0x83, 0x01, 0x01, 0x83, 0x01
, 0x01, 0x83, 0x01, 0x01, 0x83, 0x01, 0x01, 0x83, 0x01, 0x01, 0x83, 0x01, 0x01, 0x83, 0x01, 0x01
, 0x83, 0x01, 0x01, 0x83, 0x01, 0x01, 0x83, 0x01, 0x01, 0x83, 0x01, 0x01, 0x83, 0x01, 0x01, 0x83
, 0x01, 0x01, 0x83, 0x01, 0x01, 0x83, 0x01, 0x01, 0x83, 0x01, 0x01, 0x83, 0x01, 0x01, 0x83, 0x01
, 0x01,
};

void goose_send_test(void)
{
	//goosesend(goose_send1,sizeof(goose_send1));
	goosesend(0, goose_send, sizeof(goose_send));
	goosesend(1, goose_send, sizeof(goose_send));
}

void test_goose_rcv(void)
{
    //goose接收配置
    uint8 mac[6] = {0x01, 0x0c, 0xcd, 0x01, 0x00, 0x01};
	uint8 mac1[6] = {0x01, 0x0c, 0xcd, 0x01, 0x00, 0x09};
	
    //fpga_add_one_goose_rcv(mac, 0x2000, "gocbRef0", "dataSet0", "goId0", 0xFFFF);

	//fpga_add_one_goose_rcv(mac1, 0x0000, "IPACS_01PIGO/LLN0$GO$dsGOOSE1", "dsGOOSE1", "IPACS_01PIGO/LLN0$GO$dsGOOSE1", 0xFFFF);

	goose_set_rcv(0,mac, 0x2000, "gocbRef0", "dataSet0", "goId0");
	goose_set_rcv(0,mac1, 0x0000, "IPACS_01PIGO/LLN0$GO$dsGOOSE1", "dsGOOSE1", "IPACS_01PIGO/LLN0$GO$dsGOOSE1");

	goose_set_rcv(1,mac, 0x2000, "gocbRef0", "dataSet0", "goId0");
	goose_set_rcv(1,mac1, 0x0000, "IPACS_01PIGO/LLN0$GO$dsGOOSE1", "dsGOOSE1", "IPACS_01PIGO/LLN0$GO$dsGOOSE1");
}

